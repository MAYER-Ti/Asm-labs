mReadFile macro fileName_, fileHandle_, rowBegins_, rowCount_
    local readRow, done
; ?????? ?????? ????? ? ?????? ? ????
; ????????? ?????? ??????? ?????? ????? ? ?????
    mOpenFile fileName_, fileHandle_ ; ??????? ????
    
readRow:
   
    mReadFileRowToStack fileHandle_  ; ????????? ?????? ; ???????? ??? ?????????? ?????? ?????? ??????  
;    mPrintChar char                                                ; ???? ?? ?????? ?? ????? ?????
    
    mov al, '$'
    xor ah, ah
    push ax
    
    mSaveSp rowBegins_, rowCount_
    
    cmp [onEndFile], 1
    je done
    
    jmp readRow
done:    
    mCloseFile fileHandle_
    
endm


mReadFileRowToStack macro fileHandle_
    local readChar, endFile, error, done
    ; ????????? ?????? ??????????? ?? ??????? ???????? ??????,
    ; ?????? ??????????? ?????? ???????? ? ????

    
readChar:
     
    ; ?????? ???????
    mov ah, 3Fh                    ; ??????? ?????? ?????
    mov bx, fileHandle_            ; ?????????? ?????
    lea dx, bufferChar             ; ????? ??? ?????? ???????
    mov cx, 1                      ; ????????? ???? ????
    int 21h
    jc error                     ; ???? ?????? ??????, ????? ?????
    
    cmp ax, cx                      ; ????????? ????? ?????
    jl endFile                     ; ???? 0 ????, ????? ?????
    
      
    cmp bufferChar, 0Dh            ; ???????? ??????? ????? ??????   
    je readChar                   ; ???? ?? ????? ??????, ?????? ??????
    
    cmp bufferChar, 0Ah              
    je done                   
    
    ; ????????? ?????? ? ????
   ; mPrintChar bufferChar
    mov al, bufferChar             ; ????????? ??????
    xor ah, ah
    push ax                        ; ????????? ? ????
    
    
    cmp bufferChar, 0Ah              
    jne readChar
    
    jmp done
    
error:
     ; ????????? ??????
    mov ah, 4Ch
    int 21h
    mCloseFile fileHandle_ 
    mEndFile
    
endFile:
    mov [onEndFile], 1
done:
endm


mOpenFile macro fileName_, fileHandle_
    local open_error
    local done
    ; ??????? ???? (int 21h, 3Dh)
    lea dx, fileName_                   ; ????????? ?? ??? ?????
    mov ah, 3Dh                         ; ??????? ???????? ?????
    mov al, 0                           ; ????? (?????? ??????)
    mov cx, 0
    int 21h
    jc open_error                       ; ???? ??????, ???????
    jmp done
    open_error:
    ; ????? ????????? ?? ?????? ???????? ?????
    mov dx, offset open_err_msg
    mov ah, 09h
    int 21h
    mCloseFile fileHandle_
done:
    mov fileHandle_, ax                  ; ????????? ?????????? ?????
endm

mCloseFile macro fileHandle_
    ; ??????? ???? (int 21h, 3Eh)
    mov ah, 3Eh                         ; ??????? ???????? ?????
    mov bx, fileHandle                  ; ?????????? ?????
    int 21h
    
endm

mSaveSp macro spAddresses_, spCount_
    mov ax, sp                   ; ????? ??????? SP
    lea si, spAddresses_             ; ????? ?????? ???????
    mov bx, spCount_             ; ??????? ?????? ? ???????
    shl bx, 1                    ; ???????? ?????? ?? 2 (?????? ????????)
    add si, bx                   ; ????????? ? ????????? ??????? ? ???????
    mov [si], ax                 ; ????????? SP
    inc spCount_                 ; ??????????? ??????? 
endm 

mPrintSpFile macro spAddresses_, spCount_
local read_strings, read_loop, done_read




    mov cx, spCount_          ; ?????????? ??????????? ???????
    lea si, spAddresses_         ; ????? ??????? ???????

read_strings:
    mov ax, [si]                ; ????? ????? ??????
    
    mov si, ax                  ; ????? ?????? ?????? (SP)
    mov bx, ss                  ; ??????? ?????
read_loop:
    mov al, [bx:si]             ; ?????? ?????? ?? ?????
    cmp al, '$'                 ; ????????? ????? ??????
    je done_read
    mov ah, 0Eh                 ; ??????? BIOS: ????? ???????
    int 10h                     ; ?????? ???????
    add si, 2                   ; ??????? ? ?????????? ???????
    jmp read_loop
done_read:
    
    add si, 2                   ; ??????? ? ?????????? ??????
    loop read_strings           ; ????????? ??? ???? ??????????? ???????









;    mov cx, spCount_
;    lea si, spAddresses_
    
;    mov bx, [si+2]
    
;    mov dx, bx
;    mov ah, 09h
;    int 21h
    
;    mov ax, [si]                 ; ????? ????????? ????? ?? ???????
    ;    mov bx, ss                   ; ????????? ??????? ?????
    ;    mov dx, [bx:ax]              ; ?????? ?????? ?? ?????? ?? ?????
    
    
   
    

    
    ;readSp:
;    mov ax, [si]                 ; ????? ????????? ????? ?? ???????                  
         
;    mPrintChar  byte ptr [ax]   ; ?????? ?????? ?? ?????? ?? ?????
;    add si, 2                    ; ????????? ? ?????????? ??????
;    loop readSp           ; ?????????, ???? ?? ????????? ??? ??????   
    
endm



mPrintString MACRO string
   mov ah, 9
   lea dx, string
   int 21h
endm

mPrintChar MACRO char
   mov dl, char
   mov ah, 02h
   int 21h
endm

mInputString MACRO string
   mov ah, 0Ah
   mov byte ptr string, 6   ; ?????? ??? ?????
   lea dx, string
   int 21h
endm

mEndFile MACRO
   mov ah, 4ch
   int 21h
endm