.MODEL small
.STACK 100h

; === ??????? ===

; ?????? ??? ?????? ??????
PRINT MACRO msg
    lea dx, msg
    mov ah, 09h
    int 21h
ENDM

; ?????? ??? ????? ??????
INPUT MACRO buf
    lea dx, buf
    mov ah, 0Ah
    int 21h
ENDM

; ?????? ??? ??????????? ?????? (???????? ??????)
COPY_STRING MACRO source, dest
    lea si, source
    lea di, dest
    cld                     ; ????????????? ??????????? ??????
COPY_LOOP:
    lodsb                  ; ????????? ???? ?? ?????????
    cmp al, 0              ; ????? ???????
    je COPY_END
    stosb                  ; ?????????? ???? ? ????????
    jmp COPY_LOOP
COPY_END:
ENDM

; ?????? ??? ??????????? ????????? ??????
COPY_INPUT MACRO source, dest
    lea si, source
    lea di, dest
    cld                     ; ????????????? ??????????? ??????
INPUT_LOOP:
    lodsb                  ; ????????? ???? ?? ?????????
    cmp al, 0Dh            ; ????? ???????
    je INPUT_END
    stosb                  ; ?????????? ???? ? ????????
    jmp INPUT_LOOP
INPUT_END:
ENDM

; ?????? ??? ?????????? ??????? ? ??????????? ??????
APPEND_INPUT_ROD MACRO source, dest
    lea si, source
    lea di, dest
NextInputCharRod:
    mov al, [si]
    cmp al, 0Dh          ; ????? ???????
    je ProcessEnding
    mov [di], al         ; ???????? ???????
    inc si
    inc di
    jmp NextInputCharRod

ProcessEnding:
    ; ????????? ?????????
    dec di
    dec si
    mov al, [si]
    cmp al, '?'
    je ReplaceIn
    cmp al, '?'
    je ReplaceOv
    cmp al, '?'
    je ReplaceIy
    jmp EndAppendInputRod

ReplaceIn:
    dec si
    mov al, [si]
    cmp al, '?'
    je AddYna
    jmp EndAppendInputRod

AddYna:
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    jmp EndAppendInputRod

ReplaceOv:
    dec si
    mov al, [si]
    cmp al, '?'
    je AddOva
    jmp EndAppendInputRod

AddOva:
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    jmp EndAppendInputRod

ReplaceIy:
    mov al, '?'
    stosb
    jmp EndAppendInputRod

EndAppendInputRod:
    ret
ENDM

; ?????? ??? ?????????? ??????? ? ??????????
APPEND_INPUT_SUFFIX MACRO source, dest
    lea si, source
    lea di, dest
NextInputCharSuffix:
    mov al, [si]
    cmp al, 0Dh          ; ????? ???????
    je ProcessSuffix
    mov [di], al         ; ???????? ???????
    inc si
    inc di
    jmp NextInputCharSuffix

ProcessSuffix:
    dec di
    dec si
    mov al, [si]
    cmp al, '?'
    je AddSuffixIn
    cmp al, '?'
    je AddSuffixOv
    cmp al, '?'
    je AddSuffixIy
    jmp EndAppendInputWithSuffix

AddSuffixIn:
    dec si
    mov al, [si]
    cmp al, '?'
    je AddSuffixYnu
    jmp EndAppendInputWithSuffix

AddSuffixYnu:
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    jmp EndAppendInputWithSuffix

AddSuffixOv:
    dec si
    mov al, [si]
    cmp al, '?'
    je AddSuffixOvu
    jmp EndAppendInputWithSuffix

AddSuffixOvu:
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    mov al, '?'
    stosb
    jmp EndAppendInputWithSuffix

AddSuffixIy:
    mov al, '?'
    stosb
    jmp EndAppendInputWithSuffix

EndAppendInputWithSuffix:
    ret
ENDM

; ?????? ??? ?????? ?????? (? ????????)
BUILD_OUTPUT MACRO msg, source, dest
    lea si, source
    lea di, dest
    COPY_STRING msg, di        ; ????????? ?????????
    COPY_INPUT source, di      ; ????????? ???????
    mov al, 0
    stosb
ENDM

; ?????? ??? ?????? ?????? ? ??????????? ???????
BUILD_OUTPUT_WITH_ROD MACRO msg, source, dest
    lea si, source
    lea di, dest
    COPY_STRING msg, di        ; ????????? ?????????
    APPEND_INPUT_ROD source, di  ; ????????? ??????? ? ??????????
    mov al, 0
    stosb
ENDM

; ?????? ??? ?????? ?????? ? ??????????
BUILD_OUTPUT_WITH_SUFFIX MACRO msg, source, dest
    lea si, source
    lea di, dest
    COPY_STRING msg, di        ; ????????? ?????????
    APPEND_INPUT_SUFFIX source, di  ; ????????? ??????? ? ??????????
    mov al, 0
    stosb
ENDM

.data
     ; ?????????? ?????????
    enter_prompt db '??????? ???????: $'
    msg_nom db '???? ', 0           ; ???????????? ?????
    msg_gen db '??? ', 0            ; ??????????? ?????
    msg_dat db '???? ', 0           ; ????????? ?????
    msg_acc db '???? ', 0           ; ??????????? ?????
    msg_inst db '? ', 0             ; ???????????? ?????
    msg_prep db '? ', 0             ; ?????????? ?????
    newline db 0Dh, 0Ah, '$'

    ; ?????? ??? ??????
    buffer db 30 dup(0)             ; ????? ??? ????? ???????
    output_buffer db 50 dup(0)      ; ????? ??? ?????? ??????????
.code
.286
start:
    mov ax, @data
    mov ds, ax
    PRINT enter_prompt
    INPUT buffer
    lea bx, msg_nom
    BUILD_OUTPUT bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline

    lea bx, msg_gen
    BUILD_OUTPUT_WITH_ROD bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline

    lea bx, msg_dat
    BUILD_OUTPUT_WITH_SUFFIX bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline

    lea bx, msg_acc
    BUILD_OUTPUT_WITH_ROD bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline

    lea bx, msg_inst
    BUILD_OUTPUT_WITH_SUFFIX bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline

    lea bx, msg_prep
    BUILD_OUTPUT_WITH_SUFFIX bx, buffer, output_buffer
    PRINT output_buffer
    PRINT newline
    
    mov ah, 4Ch
    int 21h
END start
